<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$TITLE$</title>
    <link href="$CSS_URL$" rel="stylesheet" type="text/css" media="all">
    <link rel="icon" href="$FAVICON_DATA_URI$">
</head>
<body style="background-color: $BG_COLOR$" data-bg-color-darken="$BG_DARKEN$">
<!--<div class="screenshot-parent">-->
<div class="screenshot"></div>
<!--</div>-->
<div class="overlay">
    <div class="title">
        <a href="$LINK_URL$">$TITLE$</a>
    </div>
    <div class="link-and-date">
        <span class="link">
            $LINK_TEXT$
        </span>
    </div>
</div>
<iframe src="$IFRAME_URL$" frameborder="0" style="display: none;"></iframe>
</body>
<script id="main-script">
    document.body.dataset.devicePixelRatio = '' + window.devicePixelRatio;
    const $frame = document.querySelector('iframe');
    const $anchor = document.querySelector('.title a');
    const $overlay = document.querySelector('.overlay');
    const messageListener = window.addEventListener('message', function (messageEvent) {
        if (typeof messageEvent.data === 'object' && messageEvent.data.call === 'setScreenshot') {
            const dataUri = messageEvent.data.dataUri;
            const $screenshot = document.querySelector('.screenshot');
            fadeInScreenshot($screenshot);
            $screenshot.style.backgroundImage = 'url(' + dataUri + ')';
            // document.querySelector('.screenshot-parent').style.backgroundImage = undefined;
            $frame.remove();
            document.querySelector('#main-script').remove();
            window.removeEventListener('message', messageListener);
            $overlay.addEventListener('click', function () {
                window.location.href = $anchor.href;
            });
        }
    });
    const loadListener = $frame.addEventListener("load", function () {
        // pass the original url to the frame, so we can redirect user to it onlick
        $frame.contentWindow.postMessage({call: 'setFrameParams', url: $anchor.href, tabId: $TAB_ID$}, '*');
        $frame.removeEventListener("load", loadListener);
    });

    function fadeInScreenshot($screenshot) {
        const maxOpacity = 0.8;
        const numFrames = 25;
        let frame = 0;
        requestAnimationFrame(function doFrame() {
            const x = frame / numFrames;
            const opacity = Math.pow(x, 2) * maxOpacity; // looks like a non linear formula feels better
            $screenshot.style.opacity = opacity;
            if (frame++ < numFrames) {
                requestAnimationFrame(doFrame);
            }
        });
    }
</script>
<script src="$PARK_JS_URL$"></script>
</html>
